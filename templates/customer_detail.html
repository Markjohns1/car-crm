{% extends 'base.html' %}
{% block title %}{{ customer['name'] }} - SafiWash CRM{% endblock %}

{% block content %}
<!-- Page Header / Breadcrumb -->
<div class="mb-4">
    <div class="d-flex align-items-center mb-1">
        <a href="javascript:history.back()" class="text-muted text-decoration-none small fw-medium">
            <i class="fas fa-arrow-left me-1"></i> Back
        </a>
    </div>
    <div class="d-flex justify-content-between align-items-end">
        <div>
            <h2 class="mb-0">{{ customer['name'] }}</h2>
            <div class="text-muted small">Registered since {{ customer['joined_date'] }}</div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('edit_customer', customer_id=customer['id']) }}" class="btn btn-outline-dark">
                <i class="fas fa-pencil-alt me-1"></i> Edit Profile
            </a>
            <form action="{{ url_for('delete_customer', customer_id=customer['id']) }}" method="POST"
                onsubmit="return confirm('DANGER: This will permanently remove this customer and all their wash history. Proceed?');">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="fas fa-trash-alt me-1"></i> Delete
                </button>
            </form>
            <a href="{{ url_for('checkin') }}?customer_id={{ customer['id'] }}" class="btn btn-dark">
                <i class="fas fa-plus me-1"></i> New Visit
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Stats Column -->
    <div class="col-lg-4">
        <!-- Profile Card -->
        <div class="card mb-4">
            <div class="card-body p-4 text-center">
                <div class="avatar-circle mx-auto mb-3" style="width: 64px; height: 64px; font-size: 24px;">
                    {{ customer['name'][0].upper() }}
                </div>
                <h5 class="mb-1">{{ customer['name'] }}</h5>
                <div class="text-muted small mb-3">{{ customer['phone'] }}</div>
                <div class="badge bg-secondary mb-3">{{ customer['plate_number'] }}</div>
                {% if customer['car_model'] %}
                <div class="small text-muted"><i class="fas fa-car me-1 opacity-50"></i> {{ customer['car_model'] }}
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white border-top-0 p-0 overflow-hidden" style="border-radius: 0 0 12px 12px;">
                <div class="row g-0">
                    <div class="col-6 p-3 text-center border-end border-top">
                        <div class="text-muted extra-small text-uppercase fw-bold mb-1" style="font-size: 10px;">Total
                            Visits</div>
                        <div class="fw-bold">{{ customer['total_visits'] }}</div>
                    </div>
                    <div class="col-6 p-3 text-center border-top">
                        <div class="text-muted extra-small text-uppercase fw-bold mb-1" style="font-size: 10px;">Total
                            Spent</div>
                        <div class="fw-bold">KES {{ '{:,.0f}'.format(customer['total_spent']) }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loyalty Progress -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0 small text-uppercase fw-bold">Loyalty Status</h6>
            </div>
            <div class="card-body">
                {% set progress = (customer['loyalty_points'] / loyalty_threshold) * 100 %}
                {% if customer['loyalty_points'] >= loyalty_threshold %}
                <div class="p-3 bg-light border rounded text-center">
                    <i class="fas fa-gift text-success mb-2 fs-4"></i>
                    <div class="fw-bold small text-uppercase">Free Wash Due!</div>
                    <div class="text-muted extra-small mt-1">Ready for redemption during next visit.</div>
                </div>
                {% else %}
                <div class="mb-2 d-flex justify-content-between align-items-end">
                    <span class="small fw-semibold text-muted">Progress</span>
                    <span class="small fw-bold">{{ customer['loyalty_points'] }}/{{ loyalty_threshold }} pts</span>
                </div>
                <div class="progress mb-2">
                    <div class="progress-bar" role="progressbar" style="width: {{ progress }}%;"></div>
                </div>
                <div class="extra-small text-muted" style="font-size: 11px;">
                    {{ loyalty_threshold - customer['loyalty_points'] }} more regular visits for a free wash.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Notes -->
        {% if customer['notes'] %}
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0 small text-uppercase fw-bold">Notes</h6>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-0 italic" style="font-style: italic;">"{{ customer['notes'] }}"</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- History Column -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Visit History</h6>
                <span class="badge bg-secondary">{{ visits|length }} records</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Date</th>
                                <th>Service</th>
                                <th>Payment</th>
                                <th>Amount</th>
                                <th class="pe-4 text-end">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visit in visits %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-semibold">{{ visit['visit_date'] }}</div>
                                    <div class="text-muted extra-small" style="font-size: 11px;">{{
                                        visit['visit_time'][:5] }}</div>
                                </td>
                                <td>{{ visit['service_name'] }}</td>
                                <td>
                                    {% if visit['is_loyalty_reward'] %}
                                    <span class="text-success small fw-bold"><i class="fas fa-gift me-1"></i>Loyalty
                                        Reward</span>
                                    {% else %}
                                    <span class="text-muted small">{{ visit['payment_method'] }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if visit['is_loyalty_reward'] %}
                                    <span class="text-success fw-bold">FREE</span>
                                    {% else %}
                                    <span class="fw-bold text-dark">KES {{ '{:,.0f}'.format(visit['amount_paid'])
                                        }}</span>
                                    {% endif %}
                                </td>
                                <td class="pe-4 text-end">
                                    <span class="small text-muted fw-medium">Completed</span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <div class="opacity-25 mb-2"><i class="fas fa-history fa-2x"></i></div>
                                    No recorded visits for this customer.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}